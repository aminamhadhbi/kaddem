pipeline {
    agent any
    environment {
    registry = "aminamhadhbi/kaddem7"
    registryCredential = 'dockerHub'
    dockerImage = ''
    DOCKER_COMPOSE_FILE = 'docker-compose.yml'

    }
    stages {
        stage('Checkout') {
            steps {
                // Récupérer le code depuis le référentiel Git
                git 'https://github.com/aminamhadhbi/kaddem.git'
            }
        }
  stage('Start Containers') {
            steps {
                script {
                    // Lancer les conteneurs Docker à l'aide de Docker Compose
                    sh "docker-compose up"
                }
            }
        }
 stage('Maven Clean') {
            steps {
                // Nettoyer le projet (mvn clean)
                sh 'mvn clean'
            }
        }

        stage('Maven Compile') {
            steps {
                // Compiler le projet (mvn compile)
                sh 'mvn compile'
            }
        }
  
     stage("Deploy With Nexus") {
            steps {
              sh 'mvn clean deploy -DskipTests -Durl=http://192.168.33.10:8081/repository/maven-releases/'
            }
     }



    stage('SonarQube Analysis') {
            steps {
                    sh 'mvn sonar:sonar -Dsonar.login=admin -Dsonar.password=admin'
                }
          
        }
   stage('Build Artifact') {
            steps {
           //    Run Maven clean and package commands to build the .jar file.
                sh 'mvn clean package -DskipTests'
            }
        }
 stage('Building our image') {
            steps{
                 script {
                   dockerImage = docker.build registry + ":$BUILD_NUMBER"
                 }
            }
       }
stage('Deploy our image') {
             steps {   script {
                    docker.withRegistry('', registryCredential) {
                     dockerImage.push()
                                  }
                     }
            }
       }
    }
}

